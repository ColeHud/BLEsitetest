<html>
  <head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *">
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="css/themes/default/jquery.mobile-1.4.5.min.css">
    <title>Summon</title>
    <style>
      #head{padding:10px;text-align:center;color:#eee;background:#0af;text-shadow:none;box-shadow:0 1px 1px rgba(0,0,0,.2);}
      #head>*{margin:0;}
      .ui-li-static{font-size:14px;}
      .write::before,.writewithoutresponse::before{content:url('css/themes/default/images/icons-png/edit-black.png');float:right;}
      .value{font-size:12px;color:#888;}
    </style>
  </head>
  <body>
    <div id="head">
      <h4 id="name"></h4>
      <h4 id="id"></h4>
      <h5 id="rssi"></h5>
      <h6 id="console"></h6>
    </div>
    <ul data-role="listview" id="list"></ul>
    <script src="js/jquery.min.js"></script>
    <script src="js/jquery.mobile-1.4.5.min.js"></script>
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript">
      var SERVICES = {"1800":"Generic Access","1801":"Generic Attribute","1802":"Immediate Alert","1803":"Link Loss","1804":"Tx Power","1805":"Current Time Service","1806":"Reference Time Update Service","1807":"Next DST Change Service","1808":"Glucose","1809":"Health Thermometer","180a":"Device Information","180d":"Heart Rate","180e":"Phone Alert Status Service","180f":"Battery Service","1810":"Blood Pressure","1811":"Alert Notification Service","1812":"Human Interface Device","1813":"Scan Parameters","1814":"Running Speed and Cadence","1815":"Automation IO","1816":"Cycling Speed and Cadence","1818":"Cycling Power","1819":"Location and Navigation","181a":"Environmental Sensing","181b":"Body Composition","181c":"User Data","181d":"Weight Scale","181e":"Bond Management","181f":"Continuous Glucose Monitoring","1820":"Internet Protocol Support"};
      var CHARACTS = {"2a00":"Device Name","2a01":"Appearance","2a02":"Peripheral Privacy Flag","2a03":"Reconnection Address","2a04":"Peripheral Preferred Connection Parameters","2a05":"Service Changed","2a06":"Alert Level","2a07":"Tx Power Level","2a08":"Date Time","2a09":"Day of Week","2a0a":"Day Date Time","2a0c":"Exact Time 256","2a0d":"DST Offset","2a0e":"Time Zone","2a0f":"Local Time Information","2a11":"Time with DST","2a12":"Time Accuracy","2a13":"Time Source","2a14":"Reference Time Information","2a16":"Time Update Control Point","2a17":"Time Update State","2a18":"Glucose Measurement","2a19":"Battery Level","2a1c":"Temperature Measurement","2a1d":"Temperature Type","2a1e":"Intermediate Temperature","2a21":"Measurement Interval","2a22":"Boot Keyboard Input Report","2a23":"System ID","2a24":"Model Number String","2a25":"Serial Number String","2a26":"Firmware Revision String","2a27":"Hardware Revision String","2a28":"Software Revision String","2a29":"Manufacturer Name String","2a2a":"IEEE 11073-20601 Regulatory Certification Data List","2a2b":"Current Time","2a2c":"Magnetic Declination","2a31":"Scan Refresh","2a32":"Boot Keyboard Output Report","2a33":"Boot Mouse Input Report","2a34":"Glucose Measurement Context","2a35":"Blood Pressure Measurement","2a36":"Intermediate Cuff Pressure","2a37":"Heart Rate Measurement","2a38":"Body Sensor Location","2a39":"Heart Rate Control Point","2a3f":"Alert Status","2a40":"Ringer Control Point","2a41":"Ringer Setting","2a42":"Alert Category ID Bit Mask","2a43":"Alert Category ID","2a44":"Alert Notification Control Point","2a45":"Unread Alert Status","2a46":"New Alert","2a47":"Supported New Alert Category","2a48":"Supported Unread Alert Category","2a49":"Blood Pressure Feature","2a4a":"HID Information","2a4b":"Report Map","2a4c":"HID Control Point","2a4d":"Report","2a4e":"Protocol Mode","2a4f":"Scan Interval Window","2a50":"PnP ID","2a51":"Glucose Feature","2a52":"Record Access Control Point","2a53":"RSC Measurement","2a54":"RSC Feature","2a55":"SC Control Point","2a56":"Digital","2a58":"Analog","2a5a":"Aggregate","2a5b":"CSC Measurement","2a5c":"CSC Feature","2a5d":"Sensor Location","2a63":"Cycling Power Measurement","2a64":"Cycling Power Vector","2a65":"Cycling Power Feature","2a66":"Cycling Power Control Point","2a67":"Location and Speed","2a68":"Navigation","2a69":"Position Quality","2a6a":"LN Feature","2a6b":"LN Control Point","2a6c":"Elevation","2a6d":"Pressure","2a6e":"Temperature","2a6f":"Humidity","2a70":"True Wind Speed","2a71":"True Wind Direction","2a72":"Apparent Wind Speed","2a73":"Apparent Wind Direction","2a74":"Gust Factor","2a75":"Pollen Concentration","2a76":"UV Index","2a77":"Irradiance","2a78":"Rainfall","2a79":"Wind Chill","2a7a":"Heat Index","2a7b":"Dew Point","2a7d":"Descriptor Value Changed","2a7e":"Aerobic Heart Rate Lower Limit","2a7f":"Aerobic Threshold","2a80":"Age","2a81":"Anaerobic Heart Rate Lower Limit","2a82":"Anaerobic Heart Rate Upper Limit","2a83":"Anaerobic Threshold","2a84":"Aerobic Heart Rate Upper Limit","2a85":"Date of Birth","2a86":"Date of Threshold Assessment","2a87":"Email Address","2a88":"Fat Burn Heart Rate Lower Limit","2a89":"Fat Burn Heart Rate Upper Limit","2a8a":"First Name","2a8b":"Five Zone Heart Rate Limits","2a8c":"Gender","2a8d":"Heart Rate Max","2a8e":"Height","2a8f":"Hip Circumference","2a90":"Last Name","2a91":"Maximum Recommended Heart Rate","2a92":"Resting Heart Rate","2a93":"Sport Type for Aerobic and Anaerobic Threshold","2a94":"Three Zone Heart Rate Limits","2a95":"Two Zone Heart Rate Limit","2a96":"VO2 Max","2a97":"Waist Circumference","2a98":"Weight","2a99":"Database Change Increment","2a9a":"User Index","2a9b":"Body Composition Feature","2a9c":"Body Composition Measurement","2a9d":"Weight Measurement","2a9e":"Weight Scale Feature","2a9f":"User Control Point","2aa0":"Magnetic Flux Density - 2D","2aa1":"Magnetic Flux Density - 3D","2aa2":"Language","2aa3":"Barometric Pressure Trend","2aa4":"Bond Management Control Point","2aa5":"Bond Management Feature","2aa6":"Central Address Resolution","2aa7":"CGM Measurement","2aa8":"CGM Feature","2aa9":"CGM Status","2aaa":"CGM Session Start Time","2aab":"CGM Session Run Time","2aac":"CGM Specific Ops Control Point"};
      var DESCRIPS = {"2900":"Characteristic Extended Properties","2901":"Characteristic User Description","2902":"Client Characteristic Configuration","2903":"Server Characteristic Configuration","2904":"Characteristic Presentation Format","2905":"Characteristic Aggregate Format","2906":"Valid Range","2907":"External Report Reference","2908":"Report Reference","2909":"Number of Digitals","290a":"Value Trigger Setting","290b":"Environmental Sensing Configuration","290c":"Environmental Sensing Measurement","290d":"Environmental Sensing Trigger Setting","290e":"Time Trigger Setting"};
      var deviceID = "";
      var deviceName = "";
      var p = null;
      var app = {
        initialize: function() {
          this.bindEvents();
        },
        bindEvents: function() {
          document.addEventListener("deviceready",app.onAppReady,false);
          document.addEventListener("pause",app.onPause,false);
          document.addEventListener("resume",app.onAppReady,false);
        },
        onAppReady: function() {
          deviceID = window.gateway.getDeviceId();                                          // get device ID from Gateway
          if (p == null) p = {id:deviceID,name:window.gateway.getDeviceName(),rssi:null};
          $("body").addClass(device.platform.toLowerCase());
          app.updateHead(p,"Ready.");
          ble.isEnabled(app.onEnable,function(){ $("#console").html("Bluetooth Off."); });  // if BLE enabled,goto: onEnable, else alert user
        },
        onEnable: function() {
          app.updateHead(p,"Searching...");
          ble.stopScan();
          $.mobile.loading('show');
          ble.startScan([],app.onPeripheralFound,app.onAppReady);                           // start BLE scan; if device discovered,goto: onPeirpheralFound
        },
        onPeripheralFound: function(peripheral) {
          if (peripheral.id == deviceID) {
            p = peripheral;
            $.mobile.loading('hide');
            app.updateHead(p,"Found! Connecting...")
            ble.connect(deviceID,app.onConnect,app.onAppReady);                             // if device matches,connect; if connected,goto: onConnect
          }
        },
        onConnect: function(peripheral) {
          p = peripheral;
          app.updateHead(p,"Connected! Inspecting...");
          for (n in peripheral.services) 
            if (!$('#s'+peripheral.services[n]).length) 
              $('#list').append($("<li>",{"data-role":"list-divider","id":"s"+peripheral.services[n]}).html(SERVICES[peripheral.services[n]]||peripheral.services[n])).listview("refresh");
          for (n in peripheral.characteristics) {
            c = peripheral.characteristics[n];
            if (!$("#c"+c.characteristic).length) {
              $('#s'+c.service).after($("<li>",{"id":"c"+c.characteristic,value:""}).append($("<span>").html(CHARACTS[c.characteristic]||c.characteristic)).append($("<div>",{"class":"value"})).click(function(){if ($(this).hasClass("write")) app.write($(this).attr("id").substr(1),app.hex2ab(prompt($(this).find("span").html(),$(this).attr("value"))));})); 
              for (p in c.properties) $("#c"+c.characteristic).addClass(c.properties[p].toLowerCase());
              $("#list").listview("refresh");
            }
            if (app.writeQueue.length && app.writeQueue[0].characteristic==c.characteristic)
                ble.write(deviceID,c.service,c.characteristic,app.writeQueue[0].value,app.onWrite,ble.writeWithoutResponse(deviceID,c.service,c.characteristic,app.writeQueue[0].value,app.onWrite,app.onRWError));
            if (c.properties.indexOf("Read")>=0) {
              app.read(c)                                                                   // read characteristic; if read is good,goto: onRead 
              // if (c.properties.indexOf("Notify")>=0||c.properties.indexOf("Indicate")>=0)  // setup notifications for all who allow it
            }
          }
        },
        onRead: function(data) {
          c = app.readQueue.shift().characteristic;
          $("#c"+c).attr("value",Array.prototype.map.call(new Uint8Array(data),function(m){return ("0"+m.toString(16)).substr(-2);}).join(''));
          $("#c"+c+">.value").html(String.fromCharCode.apply(null, new Uint8Array(data))+" ["+Array.prototype.map.call(new Uint8Array(data),function(m){return ("0"+m.toString(16)).substr(-2);}).join('')+"]");
          if (app.readQueue.length) ble.read(deviceID,app.readQueue[0].service,app.readQueue[0].characteristic,app.onRead,app.onRWError);
          else {
            app.onPause();
            app.updateHead(p,"<a href='#' id='refresh' onclick='app.onAppReady()'>Refresh</a>");
          }
        },
        onWrite: function() {
          console.log("written " + JSON.stringify(app.writeQueue.shift()));
          if (app.writeQueue.length)
            for (n in p.characteristics)
              if (app.writeQueue[0].characteristic==p.characteristics[n].characteristic)
                ble.write(deviceID,p.characteristics[n].service,p.characteristics[n].characteristic,app.writeQueue[0].value,app.onWrite,ble.writeWithoutResponse(deviceID,p.characteristics[n].service,p.characteristics[n].characteristic,app.writeQueue[0].value,app.onWrite,app.onRWError));
        },
        onPause: function() {                                                               // if user leaves app,stop BLE
          ble.disconnect(deviceID,function(){deviceID="";});
          ble.stopScan();
        },
        onRWError: function() {                                                             // on error,try restarting BLE
          console.log("error");
          ble.isEnabled(deviceID,function(){},app.onAppReady);
          ble.isConnected(deviceID,function(){},app.onAppReady);
        },
        updateHead: function(peripheral,log) {
            $("#id").html(peripheral.id);
            $("#name").html(peripheral.name);
            $("#rssi").html(peripheral.rssi);
            $("#console").html(log);
        },
        read: function(characteristic) {
          app.readQueue.push(characteristic);
          if (app.readQueue.length==1) ble.read(deviceID,characteristic.service,characteristic.characteristic,app.onRead,app.onRWError);
        },
        write: function(characteristic,value) {
          app.writeQueue.push({characteristic:characteristic,value:value});
          ble.isConnected(deviceID,function(){
            if (app.writeQueue.length==1)
              for (n in p.characteristics)
                if (characteristic==p.characteristics[n].characteristic)
                  ble.write(deviceID,p.characteristics[n].service,p.characteristics[n].characteristic,value,app.onWrite,ble.writeWithoutResponse(deviceID,p.characteristics[n].service,p.characteristics[n].characteristic,value,app.onWrite,app.onRWError));
          },app.onAppReady);
        },
        hex2ab: function(str) { 
            var result = [];
            while (str.length >= 2) { 
                result.push(parseInt(str.substring(0, 2), 16));
                str = str.substring(2, str.length);
            }
            return (new Uint8Array(result)).buffer;
        },
        readQueue:[],
        writeQueue:[]
      };
      app.initialize();
    </script>
  </body>
</html>